<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgriLife - Game UI</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2e7d32;
      --secondary-color: #ffc107;
      --dark-brown: #5d4037;
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #c5e1a5;
      color: #333;
      user-select: none;
    }
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-image: url("background.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }
    .top-bar {      position: absolute;
      top: 10px;
      left: 10px;      right: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px;
      z-index: 10;
    }
    .currency-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .currency-display {
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      border: 2px solid var(--secondary-color);
    }
    .small-action-button {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .small-action-button:hover { transform: scale(1.1); }
    .small-action-button.withdraw-button {
      background: #f44336;
    }
    .right-top-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .profile-button {
      background: var(--dark-brown);
      border: 3px solid #efebe9;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s;
      z-index: 10;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }
    .profile-button:hover { transform: scale(1.1); }
    .left-side-elements {
      position: absolute;
      top: 90px;
      left: 10px;
      z-index: 9;
    }
    .farm-elements {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: flex-end;
      z-index: 11;
    }
    .warehouse-building {
      width: 140px; height: 140px;
      cursor: pointer; position: relative;      overflow: visible; transition: transform 0.2s;
    }
    .warehouse-building img {
        width: 100%; height: 100%; display: block;
    }
    .warehouse-building:hover { transform: scale(1.05); }
    .warehouse-label {
      position: absolute; left: 50%;
      transform: translateX(-50%); bottom: -8px;
      background: rgba(93,64,55,0.95); color: white;
      font-weight: 700; padding: 4px 10px;
      border-radius: 8px; font-size: 12px;
      pointer-events: none; white-space: nowrap;
    }
    .bottom-nav {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;      gap: 15px;
      z-index: 10;
      align-items: flex-end;
    }
    .nav-image-button-container {
      position: relative;
      cursor: pointer;
      text-align: center;
      transition: transform 0.2s;
    }
    .nav-image-button-container:hover {
      transform: scale(1.1);
    }
    .nav-image-button {
      width: 80px;
      height: 80px;
      display: block;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }
    .nav-image-button.muted {
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)) grayscale(100%) brightness(70%);
        opacity: 0.7;
    }
    .nav-image-label {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(93, 64, 55, 0.95);
      color: white;      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 11px;
      pointer-events: none;      white-space: nowrap;
    }
    .land-grid-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .land-grid { display: grid; gap: 5px; background: #a1887f; border: 5px solid var(--dark-brown); padding: 10px; }
    .land-cell { width: 50px; height: 50px; background-color: #795548; border: 1px solid #4e342e; cursor: pointer; position: relative; font-size: 24px; text-align: center; line-height: 50px; color: white; overflow: visible; }
    .land-cell.ready { background-color: #4caf50; animation: pulse 1.5s infinite; box-shadow: 0 0 10px rgba(76,175,80,0.6); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .grow-wrap { display: inline-block; transform-origin: 50% 100%; }
    @keyframes growScale { 0% { transform: scale(0.25); opacity: 0.6; } 60% { transform: scale(0.85); opacity: 0.95; } 100% { transform: scale(1); opacity: 1; } }
    .crop-icon { display: inline-block; filter: drop-shadow(0 1px 0 rgba(0,0,0,0.2)); pointer-events: none; }
    .crop-icon.sway { animation: sway 2.2s ease-in-out infinite; transform-origin: 50% 100%; }
    @keyframes sway { 0% { transform: translateY(0) rotate(-1deg); } 50% { transform: translateY(-2px) rotate(1deg); } 100% { transform: translateY(0) rotate(-1deg); } }
    .crop-timer { position: absolute; bottom: -20px; left: 0; right: 0; font-size: 11px; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.8); text-align: center; pointer-events: none; }
    .harvest-pop { animation: pop 250ms ease-out; }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.25); } 100% { transform: scale(0.95); } }
    .flyer { position: fixed; z-index: 1000; font-size: 26px; pointer-events: none; transform: translate(-50%, -50%); will-change: transform, left, top, opacity; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; justify-content: center; align-items: center; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .modal-content { background: #fdfbe9; padding: 20px; border-radius: 20px; border: 8px solid var(--dark-brown); width: 80%; max-width: 500px; text-align: center; position: relative; animation: fadeIn 0.3s ease-out; }
    .modal-close { position: absolute; top: -15px; right: -15px; background: #c62828; color: white; width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; font-size: 24px; font-weight: bold; cursor: pointer; }
    .modal-content h2 { color: var(--dark-brown); }
    .inventory-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; }
    .inventory-list li { background: #efebe9; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    .action { background: var(--dark-brown); color: white; border: none; border-radius: 15px; padding: 8px 12px; margin: 5px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .action:hover { background: #3e2723; transform: scale(1.05); }
    .profile-image-section { margin-bottom: 20px; }
    #profileImagePreview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--dark-brown); cursor: pointer; background-color: #e0e0e0; }
    .profile-form-container { text-align: left; margin: 20px 0; }
    .profile-form-container label { font-weight: 600; color: var(--dark-brown); display: block; margin-top: 10px; }
    .profile-form-container input, .profile-form-container textarea { width: 95%; padding: 8px; margin: 5px 0 15px 0; border-radius: 5px; border: 1px solid #ccc; }
    .modal-content .info-text { margin-top: 15px; font-style: italic; color: #555; font-size: 0.9em; text-align: left; border-top: 1px solid #eee; padding-top: 10px; }
    .modal-input { width: 90%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    .delivery-tracker-container { margin: 20px 0; position: relative; padding-bottom: 20px; }
    .delivery-tracker { position: relative; height: 120px; margin-bottom: 20px; }
    .tracker-line { position: absolute; top: 40px; left: 10%; right: 10%; height: 4px; background: repeating-linear-gradient(to right, #8d6e63 0px, #8d6e63 15px, transparent 15px, transparent 30px); border-radius: 2px; z-index: 1; }
    .tracker-dots { display: flex; justify-content: space-between; position: relative; z-index: 2; padding: 0 5%; }
    .tracker-dots > div { display: flex; flex-direction: column; align-items: center; position: relative; width: 25%; flex-shrink: 0; }
    .dot-circle { width: 30px; height: 30px; border-radius: 50%; background: #efebe9; border: 4px solid #8d6e63; position: relative; z-index: 3; margin-top: 25px; }
    .dot-label { margin-top: 10px; font-weight: bold; color: #3e2723; text-align: center; font-size: 12px; width: 100%; word-wrap: break-word; }
    .dot[data-stage="ordered"] .dot-circle { background: #ffcc80; border-color: #f57c00; }
    .dot[data-stage="packed"] .dot-circle { background: #a5d6a7; border-color: #2e7d32; }
    .dot[data-stage="out-for-delivery"] .dot-circle { background: #90caf9; border-color: #1976d2; }
    .dot[data-stage="delivered"] .dot-circle { background: #e1bee7; border-color: #7b1fa2; }    .dot.active .dot-circle { box-shadow: 0 0 0 5px rgba(255,255,255,0.7), 0 0 0 10px var(--secondary-color); transform: scale(1.1); }
    .dot.active .dot-label { color: var(--secondary-color); text-shadow: 0 0 2px rgba(0,0,0,0.5); }
    .delivery-van { position: absolute; top: 30px; left: 17.5%; font-size: 20px; z-index: 4; transition: left 1s ease-in-out; transform: translateX(-50%) scaleX(-1); color: var(--dark-brown); text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    .delivery-progress-info { margin: 15px 0; padding: 10px; background: #efebe9; border-radius: 10px; font-size: 14px; color: #3e2723; text-align: left; }
  </style>
</head>
<body>

<div class="game-container">
  <div class="top-bar">
    <div class="currency-section">
      <div class="currency-display">‚Çπ <span id="coin-display">100</span></div>
      <button class="small-action-button" onclick="openModal('addFundsModal')" title="Add Funds">+</button>
      <button class="small-action-button withdraw-button" onclick="openModal('withdrawalModal')" title="Withdraw Funds">-</button>
    </div>
    <div class="right-top-buttons">
      <div style="text-align: center;">
        <button id="mainProfileButton" class="profile-button" onclick="openModal('profileModal')"></button>
        <div id="profileNameLabel" style="font-size: 12px; font-weight: 600; color: var(--dark-brown); margin-top: 4px; text-shadow: 0 1px 1px #fff;">Profile</div>
      </div>
      <div class="nav-image-button-container" onclick="openLandMap()">
        <img src="Map.png" alt="Map" class="nav-image-button">
        <span class="nav-image-label">Map</span>
      </div>
      <div class="nav-image-button-container" id="musicButtonContainer" onclick="toggleMusic()">
        <img src="Music.png" alt="Music On/Off" class="nav-image-button" id="musicIcon">
      </div>
    </div>
  </div>
  <div class="left-side-elements">
    <div class="nav-image-button-container" onclick="openLiveCam()">
      <img src="camera.png" alt="Camera" class="nav-image-button">
      <span class="nav-image-label">Camera</span>
    </div>
  </div>
  <div class="farm-elements">
    <div class="warehouse-building" onclick="openModal('warehouseModal')">
      <img src="warehouse.png" alt="Warehouse">
      <span class="warehouse-label" aria-hidden="true">Warehouse</span>
    </div>
  </div>
  <div class="land-grid-area" id="land-grid-area">
    <p style="background:rgba(0,0,0,0.7); color:white; padding: 15px; border-radius: 10px;">
      Welcome! Click the land icon below to rent a plot and get started.
    </p>
  </div>
  <div class="bottom-nav">
    <div class="nav-image-button-container" onclick="openModal('deliveryModal')">
      <img src="delivery.png" alt="Delivery" class="nav-image-button">
      <span class="nav-image-label">Delivery</span>
    </div>
    <div class="nav-image-button-container" onclick="openModal('shopModal')">
      <img src="shop.png" alt="Shop" class="nav-image-button">
      <span class="nav-image-label">Shop</span>
    </div>
    <div class="nav-image-button-container" onclick="openModal('marketplaceModal')">
      <img src="Marketplace.png" alt="Marketplace" class="nav-image-button">
      <span class="nav-image-label">Marketplace</span>
    </div>
    <div class="nav-image-button-container" onclick="openModal('landModal')">
      <img src="land.png" alt="Rent Land" class="nav-image-button">
      <span class="nav-image-label">Rent Land</span>
    </div>
  </div>
</div>

<audio id="bgMusic" src="background_music.mp3" loop autoplay muted></audio>

<!-- All Modals -->
<div id="warehouseModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('warehouseModal')">&times;</button> <h2>üì¶ Warehouse</h2> <h3 style="text-align: left; margin-top: 10px; color: var(--dark-brown);">Harvested Crops</h3> <ul id="warehouse-harvested" class="inventory-list"></ul> <h3 style="text-align: left; margin-top: 20px; color: var(--dark-brown);">Purchased Seeds</h3> <ul id="warehouse-seeds" class="inventory-list"></ul> </div> </div>
<div id="shopModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('shopModal')">&times;</button> <h2>üè¨ Seed Shop</h2> <div id="seed-shop-content"></div> </div> </div>
<div id="landModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('landModal')">&times;</button> <h2>üåæ Rent Land</h2> <div id="land-rental-content"></div> </div> </div>
<div id="deliveryModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('deliveryModal')">&times;</button> <h2>üöö Delivery Center</h2> <div class="delivery-tracker-container"> <div class="delivery-tracker"> <div class="tracker-line"></div> <div class="tracker-dots"> <div class="dot" data-stage="ordered"><div class="dot-circle"></div><div class="dot-label">Ordered</div></div> <div class="dot" data-stage="packed"><div class="dot-circle"></div><div class="dot-label">Packed</div></div> <div class="dot" data-stage="out-for-delivery"><div class="dot-circle"></div><div class="dot-label">Out for Delivery</div></div> <div class="dot" data-stage="delivered"><div class="dot-circle"></div><div class="dot-label">Delivered</div></div> </div> <div class="delivery-van">üöö</div> </div> <div class="delivery-progress-info"> <div id="current-stage">Current Status: <span id="stage-text">Waiting for an item...</span></div> <div id="delivery-time">Estimated Total Time: <span id="time-text">--</span></div> </div> </div> <h3>Available for Delivery:</h3> <ul id="delivery-inventory" class="inventory-list"></ul> </div> </div>
<div id="marketplaceModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('marketplaceModal')">&times;</button> <h2>üè™ Marketplace</h2> <p>Sell your crops here for rupees!</p> <ul id="marketplace-list" class="inventory-list"></ul> </div> </div>
<div id="seedSelectionModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('seedSelectionModal')">&times;</button> <h2>üå± Select a Seed</h2> <p>Choose a seed to plant on this plot.</p> <div id="seed-selection-content"></div> </div> </div>
<div id="profileModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('profileModal')">&times;</button> <h2>üë§ Your Profile</h2> <div class="profile-image-section"> <label for="profileImageInput"> <img id="profileImagePreview" src="profile.jpg" alt="Profile Preview"> </label> <input type="file" id="profileImageInput" accept="image/*" style="display: none;"> <button class="action" style="margin-top:10px;" onclick="document.getElementById('profileImageInput').click();">Change Picture</button> </div> <div class="profile-form-container"> <label for="profileName">Name:</label> <input type="text" id="profileName" placeholder="Enter your name" /> <label for="profilePhone">Phone:</label> <input type="tel" id="profilePhone" placeholder="Enter phone number" /> <label for="profileEmail">Email:</label> <input type="email" id="profileEmail" placeholder="Enter email" /> <label for="profileAddress">Delivery Address:</label> <textarea id="profileAddress" placeholder="Enter full address for deliveries" rows="3"></textarea> <button class="action" onclick="saveProfile()" style="margin-top:15px; width:100%;">Save Profile</button> </div> </div> </div>
<div id="addFundsModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('addFundsModal')">&times;</button> <h2>‚ûï Add Funds</h2> <p>Increase your in-game rupees!</p> <input type="number" id="addFundsAmount" class="modal-input" placeholder="Enter amount to add" min="10" /> <button class="action" onclick="simulateAddFunds()">Add Funds</button> <p class="info-text"> This is a simulation. Real transactions require a secure payment gateway. </p> </div> </div>
<div id="withdrawalModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('withdrawalModal')">&times;</button> <h2>‚ûñ Request Withdrawal</h2> <p>Withdraw your earnings.</p> <input type="text" id="withdrawalPhone" class="modal-input" placeholder="Your Phone Number" /> <input type="number" id="withdrawalAmount" class="modal-input" placeholder="Amount to withdraw" min="10" /> <button class="action" onclick="simulateWithdrawal()">Request Withdrawal</button> <p class="info-text"> This is a simulation. Real withdrawals require secure backend processing. </p> </div> </div>
<div id="liveCamModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('liveCamModal')">&times;</button> <h2>üé• Live Camera View</h2> <p id="liveCamStatus">Loading live feed...</p> <div id="liveCamPlaceholder" style="width: 100%; height: 250px; background-color: #000;"> <video width="100%" height="100%" controls autoplay muted loop playsinline> <source src="your-live-stream.mp4" type="video/mp4"> Your browser does not support the video tag. </video> </div> <p class="info-text"> This is a demonstration. Replace the video source with your actual live stream URL from the backend. </p> </div> </div>
<div id="mapModal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close" onclick="closeModal('mapModal')">&times;</button> <h2>üó∫Ô∏è Your Land Location</h2> <p id="mapStatus">Loading map...</p> <div id="mapPlaceholder" style="width: 100%; height: 300px; background-color: #eee;"> <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d54888.02645638515!2d76.65727393125002!3d30.730302800000004!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x390fed14732c5053%3A0x84f7e26a84499140!2sOrganic%20Farms!5e0!3m2!1sen!2sin!4v1677333333333!5m2!1sen!2sin" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"> </iframe> </div> <p class="info-text"> This is an example map. The location should be dynamically loaded from the backend. </p> </div> </div>

<script>
// --- START: GAME STATE MANAGEMENT ---
let SEED_DATA = {};let LAND_CONFIG = {};
let userState = { id: null, coins: 100, ownedSeeds: {}, harvestedCrops: {}, currentLand: null, timers: {} };
const DELIVERY_STAGES = ['ordered', 'packed', 'out-for-delivery', 'delivered'];
const DELIVERY_STAGE_TIME_MS = 6000;
let activePlotIndex = null;
// This will hold the timer for the current delivery advancement
let deliveryTimeout = null;

function getGameData() {
    const data = localStorage.getItem('agriLifeGameData');
    return data ? JSON.parse(data) : { players: [], seedData: {}, landConfig: {}, deliveryQueue: [] };
}

function saveGameData(data) {
    localStorage.setItem('agriLifeGameData', JSON.stringify(data));
}

function loadGameConfiguration() {
    let gameData = getGameData();
    if (gameData && gameData.seedData && Object.keys(gameData.seedData).length > 0) {
        SEED_DATA = gameData.seedData;
        LAND_CONFIG = gameData.landConfig;
    } else {
        SEED_DATA = { 'Tomato': { cost: 5,  sellPrice: 10,  growTime: 10, emoji: 'üçÖ' }, 'Carrot': { cost: 8,  sellPrice: 15,  growTime: 15, emoji: 'ü•ï' }, 'Ruby Grape': { cost: 50, sellPrice: 120, growTime: 60, emoji: 'üçá' }, 'Strawberry': { cost: 20, sellPrice: 40,  growTime: 30, emoji: 'üçì' }, 'Corn': { cost: 12, sellPrice: 25,  growTime: 20, emoji: 'üåΩ' }, 'Pumpkin': { cost: 30, sellPrice: 70,  growTime: 45, emoji: 'üéÉ' } };
        LAND_CONFIG = { '2x2': { size: 2, rentCost: 10 }, '4x4': { size: 4, rentCost: 40 }, '6x6': { size: 6, rentCost: 90 } };
        gameData.seedData = SEED_DATA;
        gameData.landConfig = LAND_CONFIG;
        saveGameData(gameData);
    }
}

function syncPlayerState() {
    const gameData = getGameData();
    if (!userState.id) return;
    const playerIndex = gameData.players.findIndex(p => p.id === userState.id);
    if (playerIndex !== -1) {
        gameData.players[playerIndex].coins = userState.coins;
        gameData.players[playerIndex].ownedSeeds = userState.ownedSeeds;
        gameData.players[playerIndex].harvestedCrops = userState.harvestedCrops;
        saveGameData(gameData);
    }
}
// --- END: GAME STATE MANAGEMENT ---

// --- START: INITIALIZATION ---
function initialize() {
    loadGameConfiguration();    let userId = localStorage.getItem('agriLifePlayerId');
    if (!userId) {
        userId = `player_${Date.now()}`;
        localStorage.setItem('agriLifePlayerId', userId);
    }
    userState.id = userId;

    let gameData = getGameData();
    if (!gameData.players.some(p => p.id === userState.id)) {
        gameData.players.push({ id: userState.id, name: 'New Player', coins: 100, profileImage: 'profile.jpg', ownedSeeds: {}, harvestedCrops: {} });
        saveGameData(gameData);
    }

    loadProfile();
    renderShopContent();
    renderLandContent();
    updateAllUI();

    // *** NEW: Add event listener for storage changes ***
    window.addEventListener('storage', handleStorageChange);

    // *** NEW: Check for any delivery in progress when the page loads ***
    resumeInterruptedDelivery();

    document.getElementById('profileImageInput').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            document.getElementById('profileImagePreview').src = imageUrl;
            document.getElementById('mainProfileButton').style.backgroundImage = `url('${imageUrl}')`;
            const gameData = getGameData();            const player = gameData.players.find(p => p.id === userState.id);
            if(player) {
                player.profileImage = imageUrl;
                saveGameData(gameData);
            }
        }
        reader.readAsDataURL(file);
    });
}
// --- END: INITIALIZATION ---

// --- START: DELIVERY LOGIC (EVENT-DRIVEN & RELIABLE) ---

// THIS IS THE CORRECTED FUNCTION WITH STEP 2 APPLIED
function requestDelivery(cropName) {
    let gameData = getGameData();
    if (gameData.deliveryQueue.some(req => req.playerId === userState.id)) {
        alert("You already have a delivery request in the queue.");
        return;
    }
    if (!userState.harvestedCrops[cropName] || userState.harvestedCrops[cropName] <= 0) return;

    const player = gameData.players.find(p => p.id === userState.id);
    if (!player) {
        alert("Error: Could not find your player data.");
        return;
    }

    userState.harvestedCrops[cropName]--;
    const newRequest = {        id: `del_${Date.now()}`,
        playerId: userState.id,
        playerName: player.name || 'Unnamed Player',
        crop: cropName,
        status: 'pending',
        startTime: Date.now()
    };
    gameData.deliveryQueue.push(newRequest);
    saveGameData(gameData);

    alert(`1 ${cropName} has been sent for delivery approval! Please wait for the admin.`);
    updateAllUI();
    onDeliveryModalOpen();
}

// *** NEW: This function runs when the admin panel updates localStorage ***
function handleStorageChange(event) {
    if (event.key !== 'agriLifeGameData') return;

    const newData = JSON.parse(event.newValue);
    const myOldRequest = getGameData().deliveryQueue.find(req => req.playerId === userState.id);
    const myNewRequest = newData.deliveryQueue.find(req => req.playerId === userState.id);

    // Case 1: Delivery was approved by admin
    if (myOldRequest && myOldRequest.status === 'pending' && myNewRequest && myNewRequest.status === 'in_progress') {
        alert('Your delivery request has been approved!');
        advanceDeliveryStage(myNewRequest.id);
    }
    // Case 2: Delivery was declined by admin
    else if (myOldRequest && !myNewRequest) { // Request was removed from the queue
        alert(`Your delivery request for 1 ${myOldRequest.crop} was declined.`);
        // The admin panel returns the item, so we just need to update the user's state
        loadProfile(); // Reload profile to get updated crop count
        updateAllUI();
        onDeliveryModalOpen();
    }
}// *** NEW: This function runs on page load to resume a delivery ***
function resumeInterruptedDelivery() {
    const gameData = getGameData();
    const myRequest = gameData.deliveryQueue.find(req => req.playerId === userState.id && req.status === 'in_progress');
    if (myRequest) {        console.log("Resuming an in-progress delivery.");
        advanceDeliveryStage(myRequest.id);    } else {
        // If there's no active delivery, make sure the UI is reset
        updateDeliveryTrackerUI(null);
    }
}

function advanceDeliveryStage(requestId) {
    if (deliveryTimeout) clearTimeout(deliveryTimeout); // Clear any previous timer

    let gameData = getGameData();
    const request = gameData.deliveryQueue.find(req => req.id === requestId);

    if (!request || request.status !== 'in_progress') {
        updateDeliveryTrackerUI(null); // Clean up UI if request is gone
        return;
    }

    updateDeliveryTrackerUI(request.stage);

    const elapsedTime = Date.now() - request.stageStartTime;
    const remainingTime = Math.max(0, DELIVERY_STAGE_TIME_MS - elapsedTime);

    deliveryTimeout = setTimeout(() => {
        const currentData = getGameData();
        const currentRequest = currentData.deliveryQueue.find(req => req.id === requestId);
        if (!currentRequest) return;

        const currentStageIndex = DELIVERY_STAGES.indexOf(currentRequest.stage);
        const nextStageIndex = currentStageIndex + 1;

        if (nextStageIndex < DELIVERY_STAGES.length) {
            currentRequest.stage = DELIVERY_STAGES[nextStageIndex];
            currentRequest.stageStartTime = Date.now();
            saveGameData(currentData);
            advanceDeliveryStage(requestId); // Loop to the next stage
        } else {
            completeDelivery(requestId);
        }
    }, remainingTime);
}

function completeDelivery(requestId) {
    let gameData = getGameData();    const request = gameData.deliveryQueue.find(req => req.id === requestId);
    if (!request) return;

    alert(`üéâ Your ${request.crop} has been delivered!`);
    gameData.deliveryQueue = gameData.deliveryQueue.filter(req => req.id !== requestId);
    saveGameData(gameData);

    onDeliveryModalOpen();
}

function updateDeliveryTrackerUI(currentStage = null) {    const stageIndex = currentStage ? DELIVERY_STAGES.indexOf(currentStage) : -1;
    document.querySelector('.delivery-van').style.left = `${[17.5, 42.5, 67.5, 92.5][stageIndex] || 17.5}%`;
    document.getElementById('stage-text').textContent = currentStage ? getStageLabel(currentStage) : 'Waiting for an item...';

    document.querySelectorAll('.tracker-dots > div').forEach(dot => {
        const dotStageIndex = DELIVERY_STAGES.indexOf(dot.dataset.stage);
        dot.classList.toggle('active', stageIndex >= dotStageIndex);
    });
}

function onDeliveryModalOpen() {
    const el = document.getElementById('delivery-inventory');
    el.innerHTML = '';
    const gameData = getGameData();
    const myRequest = gameData.deliveryQueue.find(req => req.playerId === userState.id);

    if (myRequest) {
        let statusText = myRequest.status === 'pending' ? 'Awaiting Approval' : 'Delivery in Progress';
        el.innerHTML = `<li><span>${SEED_DATA[myRequest.crop].emoji} ${myRequest.crop} (1)</span> <span style="font-style:italic;">(${statusText})</span></li>`;
        updateDeliveryTrackerUI(myRequest.stage);
    } else {
        const availableCrops = Object.keys(userState.harvestedCrops).filter(name => userState.harvestedCrops[name] > 0);
        if (availableCrops.length === 0) {
            el.innerHTML = '<li>No crops available for delivery.</li>';
        } else {
            availableCrops.forEach(name => {
                const count = userState.harvestedCrops[name];
                const data = SEED_DATA[name];
                el.innerHTML += `<li><span>${data.emoji} ${name} (x${count})</span> <button class="action" onclick="requestDelivery('${name}')">Deliver 1</button></li>`;
            });
        }
        updateDeliveryTrackerUI(null);
    }
}
// --- END: DELIVERY LOGIC ---

// --- START: UI & CORE GAMEPLAY ---
function updateAllUI() {
    document.getElementById('coin-display').innerText = userState.coins;
    renderWarehouseContent();
    syncPlayerState();
}

function openModal(id) {
    if (id === 'deliveryModal') onDeliveryModalOpen();
    if (id === 'marketplaceModal') renderMarketplaceContent();
    document.getElementById(id).style.display = 'flex';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

function saveProfile() {
    const gameData = getGameData();    const player = gameData.players.find(p => p.id === userState.id);
    if (player) {
        player.name = document.getElementById('profileName').value;
        player.phone = document.getElementById('profilePhone').value;
        player.email = document.getElementById('profileEmail').value;
        player.address = document.getElementById('profileAddress').value;
        saveGameData(gameData);
        document.getElementById('profileNameLabel').textContent = player.name || 'Profile';
        alert(`Profile for ${player.name} saved!`);
    }
    closeModal('profileModal');
}

function loadProfile() {
    const gameData = getGameData();
    const player = gameData.players.find(p => p.id === userState.id);
    if (player) {
        document.getElementById('profileName').value = player.name || '';
        document.getElementById('profilePhone').value = player.phone || '';
        document.getElementById('profileEmail').value = player.email || '';
        document.getElementById('profileAddress').value = player.address || '';
        document.getElementById('profileNameLabel').textContent = player.name || 'Profile';
        const profileImageUrl = player.profileImage || 'profile.jpg';
        document.getElementById('profileImagePreview').src = profileImageUrl;
        document.getElementById('mainProfileButton').style.backgroundImage = `url('${profileImageUrl}')`;
        userState.coins = player.coins;
        userState.ownedSeeds = player.ownedSeeds || {};
        userState.harvestedCrops = player.harvestedCrops || {};
        document.getElementById('coin-display').innerText = userState.coins;
    }
}

function renderShopContent() {
    const el = document.getElementById('seed-shop-content');
    el.innerHTML = '';    for (const name in SEED_DATA) {
        const data = SEED_DATA[name];
        el.innerHTML += `<button class="action" onclick="buySeed('${name}')">Buy ${data.emoji} ${name} (${data.cost}‚Çπ)</button> `;
    }
}

function renderLandContent() {
    const el = document.getElementById('land-rental-content');
    el.innerHTML = '';
    for (const sizeKey in LAND_CONFIG) {
        const data = LAND_CONFIG[sizeKey];
        el.innerHTML += `<button class="action" onclick="rentLand('${sizeKey}')">Rent ${sizeKey} (${data.rentCost}‚Çπ)</button> `;
    }
}

function renderWarehouseContent() {
    const harvestedEl = document.getElementById('warehouse-harvested');
    harvestedEl.innerHTML = '';
    const crops = Object.keys(userState.harvestedCrops).filter(name => userState.harvestedCrops[name] > 0);
    if (crops.length === 0) {
        harvestedEl.innerHTML = '<li style="justify-content: center; font-style: italic;">No harvested crops yet.</li>';    } else {
        for (const name of crops) {
            const count = userState.harvestedCrops[name];
            const data = SEED_DATA[name];
            harvestedEl.innerHTML += `<li><span>${data.emoji} ${name} (x${count})</span></li>`;
        }
    }    const seedsEl = document.getElementById('warehouse-seeds');
    seedsEl.innerHTML = '';
    const seeds = Object.keys(userState.ownedSeeds).filter(name => userState.ownedSeeds[name] > 0);
    if (seeds.length === 0) {
        seedsEl.innerHTML = '<li style="justify-content: center; font-style: italic;">No purchased seeds yet.</li>';
    } else {
        for (const name of seeds) {
            const count = userState.ownedSeeds[name];
            const data = SEED_DATA[name];
            seedsEl.innerHTML += `<li><span>${data.emoji} ${name} (x${count})</span></li>`;
        }
    }
}

function renderMarketplaceContent() {
    const el = document.getElementById('marketplace-list');
    el.innerHTML = '';
    const crops = Object.keys(userState.harvestedCrops).filter(name => userState.harvestedCrops[name] > 0);
    if (crops.length === 0) {
        el.innerHTML = '<li>No crops available to sell.</li>';
        return;
    }
    for (const name of crops) {
        const count = userState.harvestedCrops[name];
        const data = SEED_DATA[name];
        el.innerHTML += `<li><span>${data.emoji} ${name} (x${count})</span> <button class="action" onclick="sellCrop('${name}')">Sell 1 (+${data.sellPrice}‚Çπ)</button></li>`;
    }
}

function buySeed(name) {
    const cost = SEED_DATA[name].cost;
    if (userState.coins < cost) {
        alert("Not enough rupees!");
        return;
    }
    userState.coins -= cost;
    userState.ownedSeeds[name] = (userState.ownedSeeds[name] || 0) + 1;
    updateAllUI();
}

function sellCrop(name) {
    if (!userState.harvestedCrops[name] || userState.harvestedCrops[name] <= 0) return;
    userState.harvestedCrops[name]--;
    userState.coins += SEED_DATA[name].sellPrice;
    updateAllUI();
    renderMarketplaceContent();
}

function rentLand(sizeKey) {
    if (userState.currentLand) {
        alert("You already have land!");
        return;
    }
    const config = LAND_CONFIG[sizeKey];
    if (userState.coins < config.rentCost) {
        alert("Not enough rupees!");
        return;
    }
    userState.coins -= config.rentCost;
    userState.currentLand = { config: config, plots: Array.from({ length: config.size * config.size }, () => ({ state: 'empty' })) };
    renderLandGrid();
    closeModal('landModal');
    updateAllUI();
    alert(`Rented a ${sizeKey} land. You can now plant crops!`);
}

function renderLandGrid() {
    const container = document.getElementById('land-grid-area');
    container.innerHTML = "";
    if (!userState.currentLand) return;
    const grid = document.createElement('div');
    grid.className = 'land-grid';
    grid.style.gridTemplateColumns = `repeat(${userState.currentLand.config.size}, 50px)`;
    userState.currentLand.plots.forEach((plot, i) => {
        const cell = document.createElement('div');        cell.className = 'land-cell';
        cell.dataset.index = i;
        cell.onclick = () => onCellClick(i);
        if (plot.state === 'growing') {
            const wrap = document.createElement('span');
            wrap.className = 'grow-wrap';
            wrap.style.animation = `growScale ${plot.growDuration / 1000}s linear forwards`;
            const icon = document.createElement('span');
            icon.className = 'crop-icon sway';
            icon.id = `icon-${i}`;
            icon.textContent = getGrowthStageIcon(plot);
            wrap.appendChild(icon);            cell.appendChild(wrap);
            const timerDiv = document.createElement('div');
            timerDiv.className = 'crop-timer';
            timerDiv.id = `timer-${i}`;
            cell.appendChild(timerDiv);
        } else if (plot.state === 'ready') {
            const icon = document.createElement('span');
            icon.className = 'crop-icon';
            icon.id = `icon-${i}`;
            icon.textContent = SEED_DATA[plot.seed].emoji;
            cell.appendChild(icon);
            cell.classList.add('ready');
        }
        grid.appendChild(cell);
    });
    container.appendChild(grid);
}

function onCellClick(index) {
    const plot = userState.currentLand.plots[index];
    if (plot.state === 'empty') {
        if (Object.keys(userState.ownedSeeds).filter(s => userState.ownedSeeds[s] > 0).length === 0) {
            alert("You have no seeds! Go to the Shop.");
            return;
        }
        openSeedSelectionModal(index);
    } else if (plot.state === 'ready') {
        harvestCrop(index);    }
}

function openSeedSelectionModal(index) {
    activePlotIndex = index;
    const contentEl = document.getElementById('seed-selection-content');
    contentEl.innerHTML = '';
    const availableSeeds = Object.keys(userState.ownedSeeds).filter(s => userState.ownedSeeds[s] > 0);
    availableSeeds.forEach(name => {
        const data = SEED_DATA[name];
        contentEl.innerHTML += `<button class="action" onclick="plantFromModal('${name}')">${data.emoji} ${name} (x${userState.ownedSeeds[name]})</button> `;
    });
    openModal('seedSelectionModal');
}

function plantFromModal(seedName) {
    if (activePlotIndex !== null) {
        plantCrop(seedName, activePlotIndex);
        closeModal('seedSelectionModal');
        activePlotIndex = null;
    }
}

function plantCrop(seedName, index) {
    if (!userState.ownedSeeds[seedName] || userState.ownedSeeds[seedName] <= 0) return;
    userState.ownedSeeds[seedName]--;
    const growTime = SEED_DATA[seedName].growTime;
    const plot = userState.currentLand.plots[index];
    plot.state = 'growing';
    plot.seed = seedName;
    plot.plantedAt = Date.now();
    plot.growDuration = growTime * 1000;
    updateAllUI();
    renderLandGrid();
    userState.timers[index] = setInterval(() => updateTimerDisplay(index), 1000);
    setTimeout(() => {
        clearInterval(userState.timers[index]);
        if (userState.currentLand?.plots[index]?.state === 'growing') {
            userState.currentLand.plots[index].state = 'ready';
            renderLandGrid();
        }
    }, growTime * 1000);
}function updateTimerDisplay(index) {
    const plot = userState.currentLand?.plots[index];
    if (!plot || plot.state !== 'growing') return;
    const remaining = Math.max(0, Math.ceil((plot.growDuration - (Date.now() - plot.plantedAt)) / 1000));
    const timerEl = document.getElementById(`timer-${index}`);
    if (timerEl) timerEl.textContent = `${remaining}s`;
}

function getGrowthStageIcon(plot) {
    const frac = Math.max(0, Math.min(1, (Date.now() - plot.plantedAt) / plot.growDuration));
    if (frac < 0.15) return 'ü´ò';
    if (frac < 0.50) return 'üå±';
    if (frac < 0.85) return 'üåø';
    return SEED_DATA[plot.seed].emoji;
}

function harvestCrop(index) {
    const plot = userState.currentLand.plots[index];
    const cell = document.querySelector(`.land-cell[data-index="${index}"]`);
    cell.querySelector('.crop-icon')?.classList.add('harvest-pop');
    flyToWarehouseBezier(SEED_DATA[plot.seed].emoji, cell).then(() => {
        userState.harvestedCrops[plot.seed] = (userState.harvestedCrops[plot.seed] || 0) + 1;
        Object.assign(plot, { state: 'empty', seed: undefined, plantedAt: undefined, growDuration: undefined });
        renderLandGrid();        updateAllUI();
    });
}

function flyToWarehouseBezier(emoji, fromEl) {    return new Promise(resolve => {
        const toEl = document.querySelector('.warehouse-building');
        if (!toEl || !fromEl) { resolve(); return; }
        const start = fromEl.getBoundingClientRect();
        const end = toEl.getBoundingClientRect();
        const flyer = document.createElement('div');
        flyer.className = 'flyer';
        flyer.textContent = emoji;
        document.body.appendChild(flyer);
        const duration = 900;
        const startTime = performance.now();
        function step(now) {
            const t = Math.min(1, (now - startTime) / duration);            const x = start.left + (end.left - start.left) * t;
            const y = start.top + (end.top - start.top) * t;
            flyer.style.left = x + 'px';
            flyer.style.top = y + 'px';
            if (t < 1) requestAnimationFrame(step);
            else { flyer.remove(); resolve(); }
        }        requestAnimationFrame(step);
    });
}

function openLiveCam() {
    if (!userState.currentLand) { alert("Rent land first!"); return; }
    openModal('liveCamModal');
    setTimeout(() => { document.getElementById('liveCamStatus').textContent = 'Live feed active!'; }, 2000);
}

function openLandMap() {
    if (!userState.currentLand) { alert("Rent land first!"); return; }
    openModal('mapModal');
    setTimeout(() => { document.getElementById('mapStatus').textContent = 'Map loaded!'; }, 1500);
}

function simulateAddFunds() {
    const amount = parseInt(document.getElementById('addFundsAmount').value);
    if (isNaN(amount) || amount <= 0) return;
    userState.coins += amount;
    updateAllUI();
    closeModal('addFundsModal');
}

function simulateWithdrawal() {
    const amount = parseInt(document.getElementById('withdrawalAmount').value);
    if (isNaN(amount) || amount <= 0 || amount > userState.coins) return;
    userState.coins -= amount;
    updateAllUI();
    closeModal('withdrawalModal');
}

function getStageLabel(stage) {
    return { 'ordered': 'Item Ordered', 'packed': 'Item Packed', 'out-for-delivery': 'Out for Delivery', 'delivered': 'Item Delivered!' }[stage] || 'Unknown';
}

function toggleMusic() {
    const bgMusic = document.getElementById('bgMusic');
    const musicIcon = document.getElementById('musicIcon');
    if (bgMusic.muted) {
        bgMusic.muted = false;
        bgMusic.play().catch(e => {
            console.warn("Music autoplay failed:", e);
            bgMusic.muted = true;
            musicIcon.classList.add('muted');
        });
        musicIcon.classList.remove('muted');
        localStorage.setItem('musicMuted', 'false');
    } else {
        bgMusic.muted = true;
        musicIcon.classList.add('muted');        localStorage.setItem('musicMuted', 'true');
    }
}

document.addEventListener('DOMContentLoaded', initialize);
// --- END: UI & CORE GAMEPLAY ---
</script>
</body>
</html>